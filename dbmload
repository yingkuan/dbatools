#!/bin/bash
# Loading DBM files, called by dbmtrans

if [ $# -ne 1 ]; then
 echo "Usage:   `basename $0` < filename > "
 exit
fi

filename=$1

export schema="event_type,event_sub_type,auction_id,event_time:timestamp,view_time:timestamp,request_time:timestamp,advertiser_id:integer,insertion_order_id,line_item_id,creative_id:integer,floodlight_id,bid_price_usd_nanos,bid_price_partner_currency_nanos,bid_price_advertiser_currency_nanos,winning_price_usd_nanos,winning_price_partner_currency_nanos,winning_price_advertiser_currency_nanos,partner_revenue_usd_nanos,partner_revenue_partner_currency_nanos,partner_revenue_advertiser_currency_nanos,total_media_cost_usd_nanos,total_media_cost_partner_currency_nanos,total_media_cost_advertiser_currency_nanos,cpm_additional_cost1_usd_nanos,cpm_additional_cost1_partner_currency_nanos,cpm_additional_cost1_advertiser_currency_nanos,cpm_additional_cost2_usd_nanos,cpm_additional_cost2_partner_currency_nanos,cpm_additional_cost2_advertiser_currency_nanos,cpm_additional_cost3_usd_nanos,cpm_additional_cost3_partner_currency_nanos,cpm_additional_cost3_advertiser_currency_nanos,cpm_additional_cost4_usd_nanos,cpm_additional_cost4_partner_currency_nanos,cpm_additional_cost4_advertiser_currency_nanos,cpm_additional_cost5_usd_nanos,cpm_additional_cost5_partner_currency_nanos,cpm_additional_cost5_advertiser_currency_nanos,percent_media_additional_cost_1_usd_nanos,percent_media_additional_cost_1_partner_currency_nanos,percent_media_additional_cost_1_advertiser_currency_nanos,percent_media_additional_cost_2_usd_nanos,percent_media_additional_cost_2_partner_currency_nanos,percent_media_additional_cost_2_advertiser_currency_nanos,percent_media_additional_cost_3_usd_nanos,percent_media_additional_cost_3_partner_currency_nanos,percent_media_additional_cost_3_advertiser_currency_nanos,percent_media_additional_cost_4_usd_nanos,percent_media_additional_cost_4_partner_currency_nanos,percent_media_additional_cost_4_advertiser_currency_nanos,percent_media_additional_cost_5_usd_nanos,percent_media_additional_cost_5_partner_currency_nanos,percent_media_additional_cost_5_advertiser_currency_nanos,data_cost_usd_nanos,data_cost_partner_currency_nanos,data_cost_advertiser_currency_nanos,billable_cost_usd_nanos,billable_cost_partner_currency_nanos,billable_cost_advertiser_currency_nanos,url,universal_site_id,language,adx_page_categories,matching_targeted_keywords,exchange,attributed_inventory_source_external_id,attributed_inventory_source_is_public,ad_position,ip,country,dma_code,postal_code,geo_region_id,city_id:integer,os_id:integer,browser_id:integer,browser_timezone_offset_minutes,net_speed,user_id,dmp_user_id,matching_targeted_segments,isp_id,device_type,mobile_make_id,mobile_model_id" 

bq load --skip_leading_rows=1 netflix.com:nfcompute:DBM.event $filename $schema 

if [ $? -ne 0 ]; then
 	 echo “ERROR: Failed to load $filename”
 	 mail -s "ERROR: Failed to load DBM file $filename" yliu@netflix.com
fi
